<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Práctica de Trigonometría</title>
    <link rel="icon" type="image/png" href="https://imgur.com/kz0k2FD.png" />

    <!-- KaTeX CSS and JS Removed -->

    <style>
      /* --- Global Styles & Reset --- */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        background-color: #f8f9fa;
        color: #343a40;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding: 20px;
      }

      h1,
      h2 {
        text-align: center;
        margin-bottom: 25px;
        color: #0056b3; /* Deep blue */
      }

      h1 {
        font-size: 2.5rem;
      }

      h2 {
        font-size: 1.8rem;
        margin-top: 30px;
      }

      /* --- Layout Containers --- */
      .container {
        max-width: 900px;
        margin: 20px auto;
        background-color: #ffffff;
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        flex-grow: 1;
      }

      .main-content {
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      /* --- Topic Selection --- */
      .topic-selector {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .topic-button {
        padding: 12px 25px;
        font-size: 1rem;
        border: 1px solid #007bff;
        border-radius: 25px; /* Pill shape */
        background-color: #ffffff;
        color: #007bff;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .topic-button:hover {
        background-color: #e7f3ff; /* Light blue on hover */
        transform: translateY(-2px);
      }

      .topic-button.active {
        background-color: #007bff;
        color: #ffffff;
        border-color: #0056b3;
        box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
      }

      /* --- Problem Area --- */
      .problem-area {
        background-color: #f8f9fa; /* Light grey background */
        padding: 25px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        min-height: 100px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #problem-display {
        font-size: 1.2rem;
        line-height: 1.8;
        text-align: center;
        color: #212529; /* Darker text */
        /* Allow wrapping */
        white-space: normal;
        word-wrap: break-word;
      }
      #problem-display code,
      #feedback code {
        font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
        background-color: #e9ecef;
        padding: 2px 5px;
        border-radius: 4px;
        font-size: 0.95em;
      }

      #feedback .explanation-step {
        margin-bottom: 0.8em;
        padding-left: 10px;
        border-left: 3px solid #007bff; /* Add a visual cue for steps */
      }
      #feedback .explanation-step ul {
        margin-left: 20px;
        list-style: disc;
      }

      /* --- Answer & Procedure --- */
      .answer-section {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
      }

      .input-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #answer-input {
        padding: 12px 15px;
        font-size: 1.1rem;
        border: 1px solid #ced4da;
        border-radius: 6px;
        min-width: 150px;
        transition: border-color 0.3s ease;
      }

      #answer-input:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      #procedure-area {
        width: 100%;
        max-width: 600px;
        height: 100px;
        padding: 10px;
        font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
        font-size: 0.95rem;
        border: 1px solid #ced4da;
        border-radius: 6px;
        resize: vertical; /* Allow vertical resize */
      }

      label[for="procedure-area"] {
        font-weight: 500;
        color: #495057;
        margin-bottom: -10px; /* Adjust spacing */
      }

      /* --- Control Buttons --- */
      .controls {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 15px;
      }

      .control-button {
        padding: 12px 28px;
        font-size: 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        font-weight: 500;
      }

      #check-button {
        background-color: #28a745; /* Green */
        color: white;
      }
      #check-button:hover:not(:disabled) {
        background-color: #218838;
        transform: translateY(-1px);
      }
      #check-button:disabled {
        background-color: #94d3a2;
        cursor: not-allowed;
      }

      #new-problem-button {
        background-color: #007bff; /* Blue */
        color: white;
      }
      #new-problem-button:hover:not(:disabled) {
        background-color: #0056b3;
        transform: translateY(-1px);
      }
      #new-problem-button:disabled {
        background-color: #7abaff;
        cursor: not-allowed;
      }

      #prev-problem-button {
        background-color: #6c757d; /* Grey */
        color: white;
      }
      #prev-problem-button:hover:not(:disabled) {
        background-color: #5a6268;
        transform: translateY(-1px);
      }
      #prev-problem-button:disabled {
        background-color: #adb5bd;
        cursor: not-allowed;
      }

      /* --- Feedback Area --- */
      #feedback {
        margin-top: 25px;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 1.1rem;
        text-align: center;
        line-height: 1.7;
        min-height: 50px;
        border: 1px solid transparent;
      }

      #feedback.correct {
        background-color: #d4edda; /* Light green */
        border-color: #c3e6cb;
        color: #155724; /* Dark green */
      }

      #feedback.incorrect {
        background-color: #f8d7da; /* Light red */
        border-color: #f5c6cb;
        color: #721c24; /* Dark red */
        text-align: left; /* Align explanation left */
      }
      #feedback strong {
        font-weight: 600;
      }
      #feedback p {
        /* Default paragraph margin in feedback */
        margin-bottom: 10px;
      }
      #feedback div p {
        /* Less margin for paragraphs inside divs */
        margin-bottom: 5px;
      }
      #feedback p:last-child {
        margin-bottom: 0;
      }

      /* --- Footer --- */
      footer {
        text-align: center;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
        color: #6c757d; /* Grey */
        font-size: 0.9rem;
      }

      /* --- Responsiveness --- */
      @media (max-width: 768px) {
        body {
          padding: 15px;
        }
        h1 {
          font-size: 2rem;
        }
        h2 {
          font-size: 1.5rem;
        }
        .container {
          padding: 20px;
        }
        .topic-selector {
          gap: 10px;
        }
        .topic-button {
          padding: 10px 20px;
          font-size: 0.9rem;
        }
        .problem-area {
          padding: 20px;
        }
        #problem-display {
          font-size: 1.1rem;
        }
        .controls {
          flex-direction: column;
          align-items: center;
        }
        .control-button {
          width: 80%;
          max-width: 300px;
        }
        #answer-input {
          min-width: 120px;
          font-size: 1rem;
        }
      }
      @media (max-width: 480px) {
        body {
          padding: 10px;
        }
        h1 {
          font-size: 1.8rem;
        }
        .container {
          padding: 15px;
        }
        .topic-button {
          padding: 8px 15px;
          font-size: 0.85rem;
          border-radius: 20px;
        }
        .input-group {
          flex-direction: column;
          align-items: stretch;
          width: 100%;
        }
        #answer-input {
          width: 100%;
          text-align: center;
        }
        label[for="procedure-area"] {
          text-align: center;
          width: 100%;
        }
        #procedure-area {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <h1>Práctica de Trigonometría</h1>

    <div class="container">
      <div class="main-content">
        <h2>Selecciona un Tema</h2>
        <div class="topic-selector" id="topic-selector">
          <button class="topic-button" data-topic="fundamental">
            Funciones Fundamentales
          </button>
          <button class="topic-button" data-topic="reciprocal">
            Funciones Recíprocas
          </button>
          <button class="topic-button" data-topic="complementary">
            Ángulos Complementarios
          </button>
          <button class="topic-button" data-topic="sine">Ley de Senos</button>
          <button class="topic-button" data-topic="cosine">
            Ley de Cosenos
          </button>
        </div>

        <h2>Problema</h2>
        <div class="problem-area">
          <div id="problem-display">Selecciona un tema para empezar.</div>
        </div>

        <div class="answer-section">
          <div class="input-group">
            <label for="answer-input">Tu Respuesta:</label>
            <input
              type="text"
              id="answer-input"
              placeholder="Escribe tu respuesta aquí"
            />
          </div>

          <label for="procedure-area">Procedimiento (Opcional):</label>
          <textarea
            id="procedure-area"
            placeholder="Puedes escribir tus notas o pasos aquí..."
          ></textarea>
        </div>

        <div class="controls">
          <button id="check-button" class="control-button" disabled>
            Revisar Respuesta
          </button>
          <button id="new-problem-button" class="control-button" disabled>
            Nuevo Problema
          </button>
          <button id="prev-problem-button" class="control-button" disabled>
            Problema Anterior
          </button>
        </div>

        <div id="feedback"></div>
      </div>
    </div>

    <footer>Hecho por Luis Humberto Montoya Herrera</footer>

    <script>
      // --- DOM Elements ---
      const topicSelector = document.getElementById("topic-selector");
      const problemDisplay = document.getElementById("problem-display");
      const answerInput = document.getElementById("answer-input");
      const procedureArea = document.getElementById("procedure-area");
      const checkButton = document.getElementById("check-button");
      const newProblemButton = document.getElementById("new-problem-button");
      const prevProblemButton = document.getElementById("prev-problem-button");
      const feedbackDiv = document.getElementById("feedback");
      const topicButtons = document.querySelectorAll(".topic-button");

      // --- State Variables ---
      let currentProblem = null;
      let previousProblem = null;
      let previousUserAnswer = "";
      let previousProcedure = "";
      let selectedTopic = null;
      const TOLERANCE = 0.015;
      const ANGLE_TOLERANCE = 0.1;
      const ANGLE_MINUTE_TOLERANCE_DEG = 0.5 / 60;

      // --- Utility Functions ---
      function degToRad(degrees) {
        return degrees * (Math.PI / 180);
      }
      function radToDeg(radians) {
        return radians * (180 / Math.PI);
      }
      function formatNumber(num, dp = 2) {
        if (typeof num !== "number" || isNaN(num)) return "";
        const rounded = parseFloat(num.toFixed(dp));
        return rounded === 0
          ? "0" + (dp > 0 ? "." + "0".repeat(dp) : "")
          : rounded.toString();
      }
      function formatAngleDegMin(degrees) {
        if (typeof degrees !== "number" || isNaN(degrees)) return "";
        if (degrees < 0 || degrees >= 360)
          console.warn("Formatting angle outside typical range:", degrees);
        const totalMinutes = degrees * 60;
        const roundedTotalMinutes = Math.round(totalMinutes);
        const deg = Math.floor(roundedTotalMinutes / 60);
        const minutes = roundedTotalMinutes % 60;
        return `${deg}° ${minutes}'`;
      }
      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }
      function getRandomFloat(min, max, dp = 1) {
        const value = Math.random() * (max - min) + min;
        return parseFloat(value.toFixed(dp));
      }

      // REMOVED renderMath function - KaTeX is not used

      function clearFeedbackAndInput() {
        feedbackDiv.innerHTML = "";
        feedbackDiv.className = "";
        answerInput.value = "";
        procedureArea.value = "";
      }
      function setButtonsState(problemGenerated) {
        checkButton.disabled = !problemGenerated;
        newProblemButton.disabled = !selectedTopic;
        prevProblemButton.disabled = !previousProblem;
      }

      // --- Problem Generation Logic ---
      function generateProblem() {
        if (currentProblem) {
          if (
            currentProblem.questionText &&
            currentProblem.questionText !== "Selecciona un tema para empezar."
          ) {
            previousProblem = { ...currentProblem };
            previousUserAnswer = answerInput.value;
            previousProcedure = procedureArea.value;
          }
        }
        clearFeedbackAndInput();
        if (!selectedTopic) {
          problemDisplay.textContent = "Por favor, selecciona un tema primero.";
          setButtonsState(false);
          prevProblemButton.disabled = true;
          return;
        }
        let problemData = null;
        try {
          switch (selectedTopic) {
            case "fundamental":
              problemData = generateFundamentalTrigProblem();
              break;
            case "reciprocal":
              problemData = generateReciprocalProblem();
              break;
            case "complementary":
              problemData = generateComplementaryProblem();
              break;
            case "sine":
              problemData = generateSineLawProblem();
              break;
            case "cosine":
              problemData = generateCosineLawProblem();
              break;
            default:
              problemDisplay.textContent = "Tema no reconocido.";
              setButtonsState(false);
              return;
          }
          if (!problemData || !problemData.questionText) {
            throw new Error(
              "Problem generation failed for topic: " + selectedTopic
            );
          }
          currentProblem = problemData;
          problemDisplay.innerHTML = currentProblem.questionText; // Use innerHTML for potential HTML in question
          // NO renderMath call here
          setButtonsState(true);
        } catch (error) {
          console.error("Error generating problem:", error);
          problemDisplay.innerHTML =
            '<p style="color:red;">Error al generar el problema. Intenta seleccionar el tema de nuevo.</p>';
          currentProblem = null;
          setButtonsState(false);
          newProblemButton.disabled = !!selectedTopic;
          prevProblemButton.disabled = !previousProblem;
        }
      }

      // --- Specific Problem Generation Functions (LaTeX replaced with Unicode/HTML) ---

      // =============================================================
      // UPDATED: Funciones Trigonométricas Fundamentales (SOH CAH TOA)
      // =============================================================
      function generateFundamentalTrigProblem() {
        const problemType = getRandomInt(1, 2); // 1: Find side, 2: Find angle
        let questionText = "";
        let correctAnswer = null;
        let explanation = "";
        let answerFormat = "";

        const units = ["cm", "m"][getRandomInt(0, 1)];
        const angleSymbol = "θ"; // Unicode theta

        if (problemType === 1) {
          // Find side
          answerFormat = "decimal";
          const angle = getRandomInt(20, 70);
          const angleRad = degToRad(angle);
          const sides = ["opposite", "adjacent", "hypotenuse"];
          const knownSideType = sides[getRandomInt(0, 2)];
          let unknownSideType = sides[getRandomInt(0, 2)];
          while (unknownSideType === knownSideType) {
            unknownSideType = sides[getRandomInt(0, 2)];
          }
          let knownValue;
          if (knownSideType === "hypotenuse") {
            knownValue = getRandomFloat(10, 50, 1);
          } else {
            if (unknownSideType === "hypotenuse") {
              knownValue = getRandomFloat(5, 30, 1);
            } else {
              knownValue = getRandomFloat(5, 40, 1);
            }
          }

          let trigFunc = "";
          let calculation;
          let explanationParts = [];

          explanationParts.push(
            `<div class="explanation-step"><p><strong>Identificación:</strong></p><ul><li>Ángulo: ${angleSymbol} = ${angle}°</li><li>Lado Conocido: ${knownSideType} = ${knownValue} ${units}</li><li>Lado a Calcular: ${unknownSideType} (llamémoslo <em>x</em>)</li></ul></div>`
          );

          if (
            (knownSideType === "opposite" &&
              unknownSideType === "hypotenuse") ||
            (knownSideType === "hypotenuse" && unknownSideType === "opposite")
          ) {
            trigFunc = "sin";
            explanationParts.push(
              `<div class="explanation-step"><p><strong>Función (SOH):</strong> <code>sin(${angleSymbol}) = opuesto / hipotenusa</code></p></div>`
            );
            if (knownSideType === "opposite") {
              calculation = knownValue / Math.sin(angleRad);
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Sustitución:</strong> <code>sin(${angle}°) = ${knownValue} / x</code></p></div>`
              );
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Despeje:</strong> <code>x = ${knownValue} / sin(${angle}°)</code><br><code>x ≈ ${knownValue} / ${formatNumber(
                  Math.sin(angleRad),
                  4
                )}</code></p></div>`
              );
            } else {
              calculation = knownValue * Math.sin(angleRad);
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Sustitución:</strong> <code>sin(${angle}°) = x / ${knownValue}</code></p></div>`
              );
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Despeje:</strong> <code>x = ${knownValue} × sin(${angle}°)</code><br><code>x ≈ ${knownValue} × ${formatNumber(
                  Math.sin(angleRad),
                  4
                )}</code></p></div>`
              );
            }
          } else if (
            (knownSideType === "adjacent" &&
              unknownSideType === "hypotenuse") ||
            (knownSideType === "hypotenuse" && unknownSideType === "adjacent")
          ) {
            trigFunc = "cos";
            explanationParts.push(
              `<div class="explanation-step"><p><strong>Función (CAH):</strong> <code>cos(${angleSymbol}) = adyacente / hipotenusa</code></p></div>`
            );
            if (knownSideType === "adjacent") {
              calculation = knownValue / Math.cos(angleRad);
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Sustitución:</strong> <code>cos(${angle}°) = ${knownValue} / x</code></p></div>`
              );
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Despeje:</strong> <code>x = ${knownValue} / cos(${angle}°)</code><br><code>x ≈ ${knownValue} / ${formatNumber(
                  Math.cos(angleRad),
                  4
                )}</code></p></div>`
              );
            } else {
              calculation = knownValue * Math.cos(angleRad);
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Sustitución:</strong> <code>cos(${angle}°) = x / ${knownValue}</code></p></div>`
              );
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Despeje:</strong> <code>x = ${knownValue} × cos(${angle}°)</code><br><code>x ≈ ${knownValue} × ${formatNumber(
                  Math.cos(angleRad),
                  4
                )}</code></p></div>`
              );
            }
          } else {
            // Opposite and Adjacent
            trigFunc = "tan";
            explanationParts.push(
              `<div class="explanation-step"><p><strong>Función (TOA):</strong> <code>tan(${angleSymbol}) = opuesto / adyacente</code></p></div>`
            );
            if (knownSideType === "opposite") {
              calculation = knownValue / Math.tan(angleRad);
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Sustitución:</strong> <code>tan(${angle}°) = ${knownValue} / x</code></p></div>`
              );
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Despeje:</strong> <code>x = ${knownValue} / tan(${angle}°)</code><br><code>x ≈ ${knownValue} / ${formatNumber(
                  Math.tan(angleRad),
                  4
                )}</code></p></div>`
              );
            } else {
              calculation = knownValue * Math.tan(angleRad);
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Sustitución:</strong> <code>tan(${angle}°) = x / ${knownValue}</code></p></div>`
              );
              explanationParts.push(
                `<div class="explanation-step"><p><strong>Despeje:</strong> <code>x = ${knownValue} × tan(${angle}°)</code><br><code>x ≈ ${knownValue} × ${formatNumber(
                  Math.tan(angleRad),
                  4
                )}</code></p></div>`
              );
            }
          }

          correctAnswer = formatNumber(calculation, 2);
          questionText = `En un triángulo rectángulo, un ángulo agudo mide ${angleSymbol} = ${angle}° y el lado <strong>${knownSideType}</strong> mide ${knownValue} ${units}. Calcula la longitud del lado <strong>${unknownSideType}</strong>. (Redondea a 2 decimales)`;
          explanationParts.push(
            `<div class="explanation-step"><p><strong>Resultado:</strong> <code>x ≈ ${correctAnswer}</code> ${units}</p></div>`
          );
          explanation = explanationParts.join("");
        } else {
          // Find angle
          answerFormat = "angle_deg_min";
          const knownSidePairs = [
            ["opposite", "hypotenuse"],
            ["adjacent", "hypotenuse"],
            ["opposite", "adjacent"],
          ];
          const [side1Type, side2Type] = knownSidePairs[getRandomInt(0, 2)];
          let side1Value, side2Value;
          if (side2Type === "hypotenuse") {
            side2Value = getRandomFloat(10, 50, 1);
            side1Value = getRandomFloat(5, side2Value * 0.9, 1);
          } else {
            side1Value = getRandomFloat(5, 40, 1);
            side2Value = getRandomFloat(5, 40, 1);
          }

          let ratio;
          let trigFunc = "";
          let inverseFunc = "";
          let explanationParts = [];

          explanationParts.push(
            `<div class="explanation-step"><p><strong>Identificación:</strong></p><ul><li>Lado ${side1Type} = ${side1Value} ${units}</li><li>Lado ${side2Type} = ${side2Value} ${units}</li><li>Ángulo a Calcular: ${angleSymbol}</li></ul></div>`
          );

          if (side1Type === "opposite" && side2Type === "hypotenuse") {
            trigFunc = "sin";
            inverseFunc = "arcsin";
            ratio = side1Value / side2Value;
            explanationParts.push(
              `<div class="explanation-step"><p><strong>Función (SOH):</strong> <code>sin(${angleSymbol}) = opuesto / hipotenusa</code><br><code>sin(${angleSymbol}) = ${side1Value} / ${side2Value} ≈ ${formatNumber(
                ratio,
                4
              )}</code></p></div>`
            );
          } else if (side1Type === "adjacent" && side2Type === "hypotenuse") {
            trigFunc = "cos";
            inverseFunc = "arccos";
            ratio = side1Value / side2Value;
            explanationParts.push(
              `<div class="explanation-step"><p><strong>Función (CAH):</strong> <code>cos(${angleSymbol}) = adyacente / hipotenusa</code><br><code>cos(${angleSymbol}) = ${side1Value} / ${side2Value} ≈ ${formatNumber(
                ratio,
                4
              )}</code></p></div>`
            );
          } else {
            // opposite and adjacent
            trigFunc = "tan";
            inverseFunc = "arctan";
            ratio = side1Value / side2Value;
            explanationParts.push(
              `<div class="explanation-step"><p><strong>Función (TOA):</strong> <code>tan(${angleSymbol}) = opuesto / adyacente</code><br><code>tan(${angleSymbol}) = ${side1Value} / ${side2Value} ≈ ${formatNumber(
                ratio,
                4
              )}</code></p></div>`
            );
          }

          ratio = Math.max(-1, Math.min(1, ratio));
          let angleRad;
          if (trigFunc === "sin") angleRad = Math.asin(ratio);
          else if (trigFunc === "cos") angleRad = Math.acos(ratio);
          else angleRad = Math.atan(ratio);
          const angleDeg = radToDeg(angleRad);
          correctAnswer = formatAngleDegMin(angleDeg);

          questionText = `En un triángulo rectángulo, el lado <strong>${side1Type}</strong> mide ${side1Value} ${units} y el lado <strong>${side2Type}</strong> mide ${side2Value} ${units}. Calcula la medida del ángulo agudo ${angleSymbol} correspondiente. (Respuesta en grados y minutos)`;
          explanationParts.push(
            `<div class="explanation-step"><p><strong>Función Inversa:</strong> <code>${angleSymbol} = ${inverseFunc}(${formatNumber(
              ratio,
              4
            )})</code></p></div>`
          );
          explanationParts.push(
            `<div class="explanation-step"><p><strong>Cálculo:</strong> <code>${angleSymbol} ≈ ${formatNumber(
              angleDeg,
              2
            )}°</code></p></div>`
          );
          explanationParts.push(
            `<div class="explanation-step"><p><strong>Formato Grados/Minutos:</strong> <code>${angleSymbol} ≈ ${correctAnswer}</code></p></div>`
          );
          explanation = explanationParts.join("");
        }

        return {
          questionText,
          correctAnswer,
          type: "fundamental",
          explanation,
          answerFormat,
        };
      }

      // 2. Reciprocal Functions (Updated for Unicode/HTML)
      function generateReciprocalProblem() {
        const type = getRandomInt(1, 4);
        let questionText = "";
        let correctAnswer = null;
        let explanation = "";
        const angle = getRandomInt(20, 70);
        const angleRad = degToRad(angle);
        let value, calcValue;
        const angleSymbol = "θ";

        switch (type) {
          case 1: // Calculate csc
            value = Math.sin(angleRad);
            if (Math.abs(value) < 0.1) value = 0.1 * Math.sign(value);
            calcValue = 1 / value;
            correctAnswer = formatNumber(calcValue);
            questionText = `Calcula <code>csc(${angle}°)</code>. (Redondea a 2 decimales)`;
            explanation = `<p>Usamos la definición <code>csc(${angleSymbol}) = 1 / sin(${angleSymbol})</code>.</p>
                                    <p><code>csc(${angle}°) = 1 / sin(${angle}°)</code></p>
                                    <p><code>csc(${angle}°) ≈ 1 / ${formatNumber(
              value,
              4
            )} ≈ ${correctAnswer}</code></p>`;
            break;
          case 2: // Calculate sec
            value = Math.cos(angleRad);
            if (Math.abs(value) < 0.1) value = 0.1 * Math.sign(value);
            calcValue = 1 / value;
            correctAnswer = formatNumber(calcValue);
            questionText = `Calcula <code>sec(${angle}°)</code>. (Redondea a 2 decimales)`;
            explanation = `<p>Usamos la definición <code>sec(${angleSymbol}) = 1 / cos(${angleSymbol})</code>.</p>
                                    <p><code>sec(${angle}°) = 1 / cos(${angle}°)</code></p>
                                    <p><code>sec(${angle}°) ≈ 1 / ${formatNumber(
              value,
              4
            )} ≈ ${correctAnswer}</code></p>`;
            break;
          case 3: // Calculate cot
            value = Math.tan(angleRad);
            if (Math.abs(value) < 0.01) value = 0.01 * Math.sign(value);
            calcValue = 1 / value;
            correctAnswer = formatNumber(calcValue);
            questionText = `Calcula <code>cot(${angle}°)</code>. (Redondea a 2 decimales)`;
            explanation = `<p>Usamos la definición <code>cot(${angleSymbol}) = 1 / tan(${angleSymbol})</code>.</p>
                                    <p><code>cot(${angle}°) = 1 / tan(${angle}°)</code></p>
                                    <p><code>cot(${angle}°) ≈ 1 / ${formatNumber(
              value,
              4
            )} ≈ ${correctAnswer}</code></p>`;
            break;
          case 4: // Solve simple reciprocal equation
            const k = getRandomFloat(1.1, 3.0);
            const func = ["sec", "csc"][getRandomInt(0, 1)];
            let targetFunc, targetValRad, targetValDeg;
            if (func === "sec") {
              targetFunc = "cos";
              targetValRad = Math.acos(1 / k);
              questionText = `Encuentra el ángulo agudo ${angleSymbol} si <code>sec(${angleSymbol}) = ${formatNumber(
                k
              )}</code>. Da la respuesta en grados, redondeada a 1 decimal.`;
              explanation = `<p>Si <code>sec(${angleSymbol}) = ${formatNumber(
                k
              )}</code>, entonces <code>cos(${angleSymbol}) = 1 / sec(${angleSymbol}) = 1 / ${formatNumber(
                k
              )} ≈ ${formatNumber(1 / k, 4)}</code>.</p>
                                         <p>Usamos la función inversa:</p>
                                         <p><code>${angleSymbol} = arccos(1 / ${formatNumber(
                k
              )})</code></p>
                                         <p><code>${angleSymbol} ≈ arccos(${formatNumber(
                1 / k,
                4
              )})</code></p>`;
            } else {
              // csc
              targetFunc = "sin";
              targetValRad = Math.asin(1 / k);
              questionText = `Encuentra el ángulo agudo ${angleSymbol} si <code>csc(${angleSymbol}) = ${formatNumber(
                k
              )}</code>. Da la respuesta en grados, redondeada a 1 decimal.`;
              explanation = `<p>Si <code>csc(${angleSymbol}) = ${formatNumber(
                k
              )}</code>, entonces <code>sin(${angleSymbol}) = 1 / csc(${angleSymbol}) = 1 / ${formatNumber(
                k
              )} ≈ ${formatNumber(1 / k, 4)}</code>.</p>
                                         <p>Usamos la función inversa:</p>
                                         <p><code>${angleSymbol} = arcsin(1 / ${formatNumber(
                k
              )})</code></p>
                                         <p><code>${angleSymbol} ≈ arcsin(${formatNumber(
                1 / k,
                4
              )})</code></p>`;
            }
            targetValDeg = radToDeg(targetValRad);
            correctAnswer = formatNumber(targetValDeg, 1);
            explanation += `<p><code>${angleSymbol} ≈ ${correctAnswer}°</code></p>`;
            break;
        }
        return {
          questionText,
          correctAnswer,
          type: "reciprocal",
          explanation,
          answerFormat: type === 4 ? "angle_deg_1dp" : "decimal",
        };
      }

      // 3. Complementary Angles (Updated for Unicode/HTML)
      function generateComplementaryProblem() {
        const type = getRandomInt(1, 3);
        let questionText = "";
        let correctAnswer = null;
        let explanation = "";
        const angle1 = getRandomInt(10, 80);
        const angle2 = 90 - angle1;
        const angleSymbol = "θ"; // Use theta for general explanations

        switch (type) {
          case 1: // Simplify
            const funcs = [
              ["sin", "cos"],
              ["cos", "sin"],
              ["tan", "cot"],
              ["cot", "tan"],
            ];
            const [f1, f2] = funcs[getRandomInt(0, 3)];
            correctAnswer = "1";
            questionText = `Simplifica la expresión: <code>${f1}(${angle1}°) / ${f2}(${angle2}°)</code>`;
            explanation = `<p>Recordamos las identidades de ángulos complementarios:<br><code>${f2}(x) = ${f1}(90° - x)</code> o <code>${f1}(x) = ${f2}(90° - x)</code>.</p>
                                   <p>En este caso, <code>${angle2}° = 90° - ${angle1}°</code>.</p>
                                   <p>Así que, <code>${f2}(${angle2}°) = ${f1}(${angle1}°)</code>.</p>
                                   <p>Sustituyendo en la expresión original:<br><code>${f1}(${angle1}°) / ${f1}(${angle1}°) = 1</code></p>`;
            break;
          case 2: // Solve equation
            let c1, c2, k1, k2, x;
            let attempts = 0;
            do {
              c1 = getRandomInt(1, 3);
              c2 = getRandomInt(1, 3);
              k1 = getRandomInt(-20, 20);
              k2 = getRandomInt(-20, 20);
              if (c1 + c2 === 0) continue;
              x = (90 - k1 - k2) / (c1 + c2);
              attempts++;
              if (
                x > 0 &&
                x < 40 &&
                c1 * x + k1 > 0 &&
                c1 * x + k1 < 90 &&
                c2 * x + k2 > 0 &&
                c2 * x + k2 < 90
              ) {
                break;
              }
            } while (attempts < 20);
            if (attempts >= 20 || x <= 0 || x >= 40 || isNaN(x)) {
              c1 = 2;
              k1 = 10;
              c2 = 1;
              k2 = 20;
              x = 20;
            }
            const expr1 = `${c1}x ${k1 >= 0 ? "+" : ""} ${k1}`;
            const expr2 = `${c2}x ${k2 >= 0 ? "+" : ""} ${k2}`;
            questionText = `Encuentra el valor de <em>x</em> si <code>sin(${expr1})° = cos(${expr2})°</code>.`;
            correctAnswer = formatNumber(x, 1);
            explanation = `<p>Si <code>sin(A) = cos(B)</code>, y A y B son ángulos agudos, entonces <code>A + B = 90°</code>.</p>
                                     <p>Aquí, <code>A = (${expr1})°</code> y <code>B = (${expr2})°</code>.</p>
                                     <p><code>(${expr1}) + (${expr2}) = 90</code></p>
                                     <p><code>(${c1 + c2})x + (${
              k1 + k2
            }) = 90</code></p>
                                     <p><code>${c1 + c2}x = 90 - (${
              k1 + k2
            })</code></p>
                                     <p><code>${c1 + c2}x = ${
              90 - (k1 + k2)
            }</code></p>
                                     <p><code>x = ${90 - (k1 + k2)} / ${
              c1 + c2
            } = ${correctAnswer}</code></p>`;
            break;
          case 3: // Evaluate expression
            const a = getRandomInt(15, 40);
            const b = 90 - a;
            const exprType = getRandomInt(1, 2);
            if (exprType === 1) {
              // tan * tan or cot * cot
              const func = ["tan", "cot"][getRandomInt(0, 1)];
              correctAnswer = "1";
              questionText = `Evalúa: <code>${func}(${a}°) × ${func}(${b}°)</code>`;
              explanation = `<p>Recordamos que <code>tan(90° - x) = cot(x)</code> y <code>cot(90° - x) = tan(x)</code>.</p>
                                        <p>Tenemos <code>${func}(${b}°) = ${func}(90° - ${a}°)</code>.</p>
                                        <p>Si ${func} es 'tan', <code>tan(${b}°) = cot(${a}°) = 1 / tan(${a}°)</code>.</p>
                                        <p>Si ${func} es 'cot', <code>cot(${b}°) = tan(${a}°) = 1 / cot(${a}°)</code>.</p>
                                        <p>En ambos casos, la expresión es: <code>${func}(${a}°) × (1 / ${func}(${a}°)) = 1</code></p>`;
            } else {
              // sin² + sin² or cos² + cos²
              const func = ["sin", "cos"][getRandomInt(0, 1)];
              correctAnswer = "1";
              questionText = `Evalúa: <code>${func}²(${a}°) + ${func}²(${b}°)</code>`;
              explanation = `<p>Recordamos que <code>sin(90° - x) = cos(x)</code> y <code>cos(90° - x) = sin(x)</code>.</p>
                                        <p>Tenemos <code>${func}(${b}°) = ${func}(90° - ${a}°)</code>.</p>
                                        <p>Si ${func} es 'sin', <code>sin(${b}°) = cos(${a}°)</code>. La expresión es <code>sin²(${a}°) + cos²(${a}°)</code>.</p>
                                        <p>Si ${func} es 'cos', <code>cos(${b}°) = sin(${a}°)</code>. La expresión es <code>cos²(${a}°) + sin²(${a}°)</code>.</p>
                                        <p>Usando la identidad pitagórica <code>sin²(${angleSymbol}) + cos²(${angleSymbol}) = 1</code>, el resultado es 1.</p>
                                        <p><code>${func}²(${a}°) + ${
                func === "sin" ? "cos" : "sin"
              }²(${a}°) = 1</code></p>`;
            }
            break;
        }
        return {
          questionText,
          correctAnswer,
          type: "complementary",
          explanation,
          answerFormat: type === 2 ? "decimal_1dp" : "integer",
        };
      }

      // 4. Sine Law (Updated for Unicode/HTML)
      function generateSineLawProblem() {
        const type = getRandomInt(1, 3);
        let questionText = "";
        let correctAnswer = null;
        let explanation = "";
        let A, B, C, a, b, c;
        let knownA, knownB, knownC, known_a, known_b, known_c;
        let findSide = null;
        let findAngle = null;
        const triangleSymbol = "△"; // Or ∆

        switch (type) {
          case 1: // AAS -> Find side
            findSide = ["a", "b", "c"][getRandomInt(0, 2)];
            knownA = getRandomInt(30, 80);
            knownB = getRandomInt(30, 140 - knownA);
            knownC = 180 - knownA - knownB;
            const knownSideIndex = getRandomInt(0, 2);
            const knownAngle = [knownA, knownB, knownC][knownSideIndex];
            const knownSideLabel = ["a", "b", "c"][knownSideIndex];
            const knownSideValue = getRandomFloat(10, 50);
            if (knownSideLabel === "a") known_a = knownSideValue;
            if (knownSideLabel === "b") known_b = knownSideValue;
            if (knownSideLabel === "c") known_c = knownSideValue;
            let targetAngle, targetAngleLabel;
            if (findSide === "a") {
              targetAngle = knownA;
              targetAngleLabel = "A";
            }
            if (findSide === "b") {
              targetAngle = knownB;
              targetAngleLabel = "B";
            }
            if (findSide === "c") {
              targetAngle = knownC;
              targetAngleLabel = "C";
            }
            let calcValue =
              (knownSideValue / Math.sin(degToRad(knownAngle))) *
              Math.sin(degToRad(targetAngle));
            correctAnswer = formatNumber(calcValue);
            questionText = `En un triángulo ${triangleSymbol}ABC, el ángulo A = ${knownA}°, el ángulo B = ${knownB}°, y el lado <strong>${knownSideLabel}</strong> = ${knownSideValue} cm. Calcula la longitud del lado <strong>${findSide}</strong>. (Redondea a 2 decimales)`;
            explanation = `<p><strong>1. Hallar tercer ángulo:</strong> C = 180° - A - B = 180° - ${knownA}° - ${knownB}° = ${knownC}°.</p>
                                   <p><strong>2. Ley de Senos:</strong> <code>a / sin A = b / sin B = c / sin C</code></p>
                                   <p><strong>3. Identificar Proporción:</strong> Queremos ${findSide}$. Conocemos ${knownSideLabel}=${knownSideValue}$ (opuesto a ${
              ["A", "B", "C"][knownSideIndex]
            }=${knownAngle}°) y el ángulo opuesto a ${findSide}$ es ${targetAngleLabel}=${targetAngle}°.
                                   <br><code>${findSide} / sin(${targetAngle}°) = ${knownSideLabel} / sin(${knownAngle}°)</code></p>
                                   <p><strong>4. Despejar ${findSide}:</strong> <code>${findSide} = (${knownSideLabel} × sin(${targetAngle}°)) / sin(${knownAngle}°)</code></p>
                                   <p><strong>5. Calcular:</strong> <code>${findSide} = (${knownSideValue} × sin(${targetAngle}°)) / sin(${knownAngle}°)</code>
                                   <br><code>${findSide} ≈ (${knownSideValue} × ${formatNumber(
              Math.sin(degToRad(targetAngle)),
              4
            )}) / ${formatNumber(
              Math.sin(degToRad(knownAngle)),
              4
            )} ≈ ${correctAnswer}</code> cm</p>`;
            break;
          case 2: // ASA -> Find side
            findSide = ["a", "b", "c"][getRandomInt(0, 2)];
            knownA = getRandomInt(30, 80);
            knownC = getRandomInt(30, 140 - knownA);
            knownB = 180 - knownA - knownC;
            known_a = null;
            known_b = null;
            known_c = null;
            const includedSideIndex = getRandomInt(0, 2);
            let sideLabel, angle1, angle2, knownSideVal;
            if (includedSideIndex === 0) {
              angle1 = knownA;
              angle2 = knownC;
              sideLabel = "b";
              known_b = getRandomFloat(10, 50);
              knownSideVal = known_b;
            } else if (includedSideIndex === 1) {
              angle1 = knownB;
              angle2 = knownC;
              sideLabel = "a";
              known_a = getRandomFloat(10, 50);
              knownSideVal = known_a;
            } else {
              angle1 = knownA;
              angle2 = knownB;
              sideLabel = "c";
              known_c = getRandomFloat(10, 50);
              knownSideVal = known_c;
            }
            const knownAngle1 = angle1;
            const knownAngle2 = angle2;
            const knownSideOppositeAngle = 180 - knownAngle1 - knownAngle2;
            const knownSideOppositeAngleLabel = sideLabel.toUpperCase();
            let targetAngleASA, targetAngleLabelASA;
            if (findSide === "a") {
              targetAngleASA = knownA;
              targetAngleLabelASA = "A";
            }
            if (findSide === "b") {
              targetAngleASA = knownB;
              targetAngleLabelASA = "B";
            }
            if (findSide === "c") {
              targetAngleASA = knownC;
              targetAngleLabelASA = "C";
            }
            calcValue =
              (knownSideVal / Math.sin(degToRad(knownSideOppositeAngle))) *
              Math.sin(degToRad(targetAngleASA));
            correctAnswer = formatNumber(calcValue);
            let angleLabel1Text, angleLabel2Text;
            if (sideLabel === "a") {
              angleLabel1Text = "B";
              angleLabel2Text = "C";
            } else if (sideLabel === "b") {
              angleLabel1Text = "A";
              angleLabel2Text = "C";
            } else {
              angleLabel1Text = "A";
              angleLabel2Text = "B";
            }
            questionText = `En ${triangleSymbol}ABC, el ángulo ${angleLabel1Text} = ${knownAngle1}°, el ángulo ${angleLabel2Text} = ${knownAngle2}°, y el lado incluido <strong>${sideLabel}</strong> = ${knownSideVal} m. Calcula la longitud del lado <strong>${findSide}</strong>. (Redondea a 2 decimales)`;
            explanation = `<p><strong>1. Hallar tercer ángulo (opuesto a ${sideLabel}):</strong> ${knownSideOppositeAngleLabel} = 180° - ${knownAngle1}° - ${knownAngle2}° = ${knownSideOppositeAngle}°.</p>
                                    <p><strong>2. Ley de Senos:</strong> <code>a / sin A = b / sin B = c / sin C</code></p>
                                    <p><strong>3. Identificar Proporción:</strong> Queremos ${findSide}$. Conocemos ${sideLabel}=${knownSideVal}$ (opuesto a ${knownSideOppositeAngleLabel}=${knownSideOppositeAngle}°) y el ángulo opuesto a ${findSide}$ es ${targetAngleLabelASA}=${targetAngleASA}°.
                                    <br><code>${findSide} / sin(${targetAngleASA}°) = ${sideLabel} / sin(${knownSideOppositeAngle}°)</code></p>
                                    <p><strong>4. Despejar ${findSide}:</strong> <code>${findSide} = (${sideLabel} × sin(${targetAngleASA}°)) / sin(${knownSideOppositeAngle}°)</code></p>
                                    <p><strong>5. Calcular:</strong> <code>${findSide} = (${knownSideVal} × sin(${targetAngleASA}°)) / sin(${knownSideOppositeAngle}°)</code>
                                    <br><code>${findSide} ≈ (${knownSideVal} × ${formatNumber(
              Math.sin(degToRad(targetAngleASA)),
              4
            )}) / ${formatNumber(
              Math.sin(degToRad(knownSideOppositeAngle)),
              4
            )} ≈ ${correctAnswer}</code> m</p>`;
            break;
          case 3: // SSA -> Find Angle (non-ambiguous)
            findAngle = ["A", "B", "C"][getRandomInt(0, 2)];
            let knownAngleSSA,
              knownSideOpp,
              otherKnownSide,
              otherKnownSideLabel;
            let attempts = 0;
            do {
              knownAngleSSA = getRandomInt(30, 80);
              knownSideOpp = getRandomFloat(15, 40);
              otherKnownSide = getRandomFloat(10, knownSideOpp - 1);
              attempts++;
              const sinValCheck =
                (otherKnownSide * Math.sin(degToRad(knownAngleSSA))) /
                knownSideOpp;
              if (sinValCheck > 0 && sinValCheck <= 1) break;
            } while (attempts < 20);
            if (attempts >= 20) {
              knownAngleSSA = 45;
              knownSideOpp = 20;
              otherKnownSide = 15;
              console.warn("SSA generation failed, fallback used");
            }
            const knownAngleLabelSSA = ["A", "B", "C"][getRandomInt(0, 2)];
            const knownSideOppLabel = knownAngleLabelSSA.toLowerCase();
            let otherKnownSideLabelIndex = getRandomInt(0, 2);
            while (
              otherKnownSideLabelIndex ===
              ["A", "B", "C"].indexOf(knownAngleLabelSSA)
            ) {
              otherKnownSideLabelIndex = getRandomInt(0, 2);
            }
            otherKnownSideLabel = ["a", "b", "c"][otherKnownSideLabelIndex];
            findAngle = otherKnownSideLabel.toUpperCase();
            const sinTargetAngle =
              (otherKnownSide * Math.sin(degToRad(knownAngleSSA))) /
              knownSideOpp;
            const clampedSinTargetAngle = Math.max(
              0,
              Math.min(1, sinTargetAngle)
            );
            const targetAngleRad = Math.asin(clampedSinTargetAngle);
            const targetAngleDeg = radToDeg(targetAngleRad);
            correctAnswer = formatAngleDegMin(targetAngleDeg);
            questionText = `En ${triangleSymbol}ABC, el ángulo ${knownAngleLabelSSA} = ${knownAngleSSA}°, el lado <strong>${knownSideOppLabel}</strong> = ${knownSideOpp} cm, y el lado <strong>${otherKnownSideLabel}</strong> = ${otherKnownSide} cm. Calcula la medida del ángulo <strong>${findAngle}</strong>. (Da la respuesta en grados y minutos)`;
            explanation = `<p><strong>1. Ley de Senos:</strong> <code>a / sin A = b / sin B = c / sin C</code></p>
                                    <p><strong>2. Identificar Proporción:</strong> Conocemos ${knownAngleLabelSSA}=${knownAngleSSA}°$, su opuesto ${knownSideOppLabel}=${knownSideOpp}$, y el lado ${otherKnownSideLabel}=${otherKnownSide}$. Buscamos el ángulo ${findAngle}$ (opuesto a ${otherKnownSideLabel}$).
                                    <br><code>${otherKnownSideLabel} / sin(${findAngle}) = ${knownSideOppLabel} / sin(${knownAngleLabelSSA})</code></p>
                                    <p><strong>3. Despejar sin(${findAngle}):</strong> <code>sin(${findAngle}) = (${otherKnownSideLabel} × sin(${knownAngleLabelSSA}°)) / ${knownSideOppLabel}</code></p>
                                    <p><strong>4. Calcular sin(${findAngle}):</strong> <code>sin(${findAngle}) = (${otherKnownSide} × sin(${knownAngleSSA}°)) / ${knownSideOpp}</code>
                                    <br><code>sin(${findAngle}) ≈ (${otherKnownSide} × ${formatNumber(
              Math.sin(degToRad(knownAngleSSA)),
              4
            )}) / ${knownSideOpp} ≈ ${formatNumber(
              sinTargetAngle,
              4
            )}</code></p>
                                    <p><strong>5. Hallar ángulo:</strong> <code>${findAngle} = arcsin(${formatNumber(
              sinTargetAngle,
              4
            )})</code>
                                    <br><code>${findAngle} ≈ ${formatNumber(
              targetAngleDeg,
              2
            )}°</code></p>
                                    <p><strong>6. Formato Grados/Minutos:</strong> <code>${findAngle} ≈ ${correctAnswer}</code></p>`;
            break;
        }
        return {
          questionText,
          correctAnswer,
          type: "sine",
          explanation,
          answerFormat: type === 3 ? "angle_deg_min" : "decimal",
        };
      }

      // 5. Cosine Law (Updated for Unicode/HTML)
      function generateCosineLawProblem() {
        const type = getRandomInt(1, 2);
        let questionText = "";
        let correctAnswer = null;
        let explanation = "";
        let A, B, C, a, b, c;
        const triangleSymbol = "△"; // Or ∆

        switch (type) {
          case 1: // SAS -> Find side
            const knownAngleLabel = ["A", "B", "C"][getRandomInt(0, 2)];
            const knownAngle = getRandomInt(30, 150);
            const side1Value = getRandomFloat(10, 40);
            const side2Value = getRandomFloat(10, 40);
            let side1Label, side2Label;
            if (knownAngleLabel === "A") {
              side1Label = "b";
              side2Label = "c";
            } else if (knownAngleLabel === "B") {
              side1Label = "a";
              side2Label = "c";
            } else {
              side1Label = "a";
              side2Label = "b";
            }
            const targetSideLabel = knownAngleLabel.toLowerCase();
            let targetSideSq =
              side1Value ** 2 +
              side2Value ** 2 -
              2 * side1Value * side2Value * Math.cos(degToRad(knownAngle));
            if (targetSideSq <= 0) {
              console.warn("Cosine Law non-positive side², regenerating...");
              return generateCosineLawProblem();
            }
            const targetSideValue = Math.sqrt(targetSideSq);
            correctAnswer = formatNumber(targetSideValue);
            questionText = `En ${triangleSymbol}ABC, el lado <strong>${side1Label}</strong> = ${side1Value} cm, el lado <strong>${side2Label}</strong> = ${side2Value} cm, y el ángulo incluido <strong>${knownAngleLabel}</strong> = ${knownAngle}°. Calcula la longitud del lado <strong>${targetSideLabel}</strong>. (Redondea a 2 decimales)`;
            explanation = `<p><strong>1. Ley de Cosenos (para lado):</strong> <code>a² = b² + c² - 2bc cos A</code> (y formas análogas para b² y c²)</p>
                                   <p><strong>2. Identificar Fórmula:</strong> Buscamos ${targetSideLabel}$. Conocemos los otros dos lados (${side1Label}=${side1Value}, ${side2Label}=${side2Value}) y el ángulo incluido ${knownAngleLabel}=${knownAngle}°.
                                   <br>Fórmula: <code>${targetSideLabel}² = ${side1Label}² + ${side2Label}² - 2(${side1Label})(${side2Label}) cos(${knownAngleLabel})</code></p>
                                   <p><strong>3. Sustituir:</strong> <code>${targetSideLabel}² = ${side1Value}² + ${side2Value}² - 2(${side1Value})(${side2Value}) cos(${knownAngle}°)</code></p>
                                   <p><strong>4. Calcular ${targetSideLabel}²:</strong> <code>${targetSideLabel}² = ${formatNumber(
              side1Value ** 2
            )} + ${formatNumber(
              side2Value ** 2
            )} - 2(${side1Value})(${side2Value}) × (${formatNumber(
              Math.cos(degToRad(knownAngle)),
              4
            )})</code>
                                   <br><code>${targetSideLabel}² ≈ ${formatNumber(
              side1Value ** 2 + side2Value ** 2
            )} - ${formatNumber(
              2 * side1Value * side2Value * Math.cos(degToRad(knownAngle)),
              4
            )}</code>
                                   <br><code>${targetSideLabel}² ≈ ${formatNumber(
              targetSideSq,
              4
            )}</code></p>
                                   <p><strong>5. Hallar ${targetSideLabel}:</strong> <code>${targetSideLabel} = √(${formatNumber(
              targetSideSq,
              4
            )})</code>
                                   <br><code>${targetSideLabel} ≈ ${correctAnswer}</code> cm</p>`;
            break;
          case 2: // SSS -> Find angle
            const findAngleLabel = ["A", "B", "C"][getRandomInt(0, 2)];
            let side_a, side_b, side_c;
            let attempts = 0;
            do {
              side_a = getRandomFloat(10, 30);
              side_b = getRandomFloat(10, 30);
              const min_c = Math.max(0.1, Math.abs(side_a - side_b) + 0.1);
              const max_c = side_a + side_b - 0.1;
              if (min_c >= max_c) {
                attempts++;
                continue;
              }
              side_c = getRandomFloat(min_c, max_c);
              side_a = parseFloat(side_a.toFixed(1));
              side_b = parseFloat(side_b.toFixed(1));
              side_c = parseFloat(side_c.toFixed(1));
              attempts++;
            } while (
              (side_a + side_b <= side_c ||
                side_a + side_c <= side_b ||
                side_b + side_c <= side_a) &&
              attempts < 30
            );
            if (
              attempts >= 30 ||
              side_a + side_b <= side_c ||
              side_a + side_c <= side_b ||
              side_b + side_c <= side_a
            ) {
              side_a = 10;
              side_b = 15;
              side_c = 20;
              console.warn("SSS generation failed, fallback used");
            }
            let cosAngleValue;
            let formulaStr = "";
            let calculationStr = "";
            if (findAngleLabel === "A") {
              cosAngleValue =
                (side_b ** 2 + side_c ** 2 - side_a ** 2) /
                (2 * side_b * side_c);
              formulaStr = `cos A = (b² + c² - a²) / (2bc)`;
              calculationStr = `cos A = (${formatNumber(
                side_b
              )}² + ${formatNumber(side_c)}² - ${formatNumber(
                side_a
              )}²) / (2 × ${formatNumber(side_b)} × ${formatNumber(side_c)})`;
              calculationStr += `<br>cos A = (${formatNumber(
                side_b ** 2
              )} + ${formatNumber(side_c ** 2)} - ${formatNumber(
                side_a ** 2
              )}) / (${formatNumber(2 * side_b * side_c)})`;
              calculationStr += `<br>cos A = ${formatNumber(
                side_b ** 2 + side_c ** 2 - side_a ** 2
              )} / ${formatNumber(2 * side_b * side_c)} ≈ ${formatNumber(
                cosAngleValue,
                4
              )}`;
            } else if (findAngleLabel === "B") {
              cosAngleValue =
                (side_a ** 2 + side_c ** 2 - side_b ** 2) /
                (2 * side_a * side_c);
              formulaStr = `cos B = (a² + c² - b²) / (2ac)`;
              calculationStr = `cos B = (${formatNumber(
                side_a
              )}² + ${formatNumber(side_c)}² - ${formatNumber(
                side_b
              )}²) / (2 × ${formatNumber(side_a)} × ${formatNumber(side_c)})`;
              calculationStr += `<br>cos B = (${formatNumber(
                side_a ** 2
              )} + ${formatNumber(side_c ** 2)} - ${formatNumber(
                side_b ** 2
              )}) / (${formatNumber(2 * side_a * side_c)})`;
              calculationStr += `<br>cos B = ${formatNumber(
                side_a ** 2 + side_c ** 2 - side_b ** 2
              )} / ${formatNumber(2 * side_a * side_c)} ≈ ${formatNumber(
                cosAngleValue,
                4
              )}`;
            } else {
              // 'C'
              cosAngleValue =
                (side_a ** 2 + side_b ** 2 - side_c ** 2) /
                (2 * side_a * side_b);
              formulaStr = `cos C = (a² + b² - c²) / (2ab)`;
              calculationStr = `cos C = (${formatNumber(
                side_a
              )}² + ${formatNumber(side_b)}² - ${formatNumber(
                side_c
              )}²) / (2 × ${formatNumber(side_a)} × ${formatNumber(side_b)})`;
              calculationStr += `<br>cos C = (${formatNumber(
                side_a ** 2
              )} + ${formatNumber(side_b ** 2)} - ${formatNumber(
                side_c ** 2
              )}) / (${formatNumber(2 * side_a * side_b)})`;
              calculationStr += `<br>cos C = ${formatNumber(
                side_a ** 2 + side_b ** 2 - side_c ** 2
              )} / ${formatNumber(2 * side_a * side_b)} ≈ ${formatNumber(
                cosAngleValue,
                4
              )}`;
            }
            cosAngleValue = Math.max(-1, Math.min(1, cosAngleValue)); // Clamp value
            const targetAngleRad = Math.acos(cosAngleValue);
            const targetAngleDeg = radToDeg(targetAngleRad);
            correctAnswer = formatAngleDegMin(targetAngleDeg);
            questionText = `En ${triangleSymbol}ABC, los lados miden <strong>a</strong> = ${formatNumber(
              side_a
            )} m, <strong>b</strong> = ${formatNumber(
              side_b
            )} m, y <strong>c</strong> = ${formatNumber(
              side_c
            )} m. Calcula la medida del ángulo <strong>${findAngleLabel}</strong>. (Da la respuesta en grados y minutos)`;
            explanation = `<p><strong>1. Ley de Cosenos (para ángulo):</strong> <code>${formulaStr}</code></p>
                                   <p><strong>2. Calcular cos ${findAngleLabel}:</strong><br><code>${calculationStr}</code></p>
                                   <p><strong>3. Hallar ángulo ${findAngleLabel}:</strong> <code>${findAngleLabel} = arccos(${formatNumber(
              cosAngleValue,
              4
            )})</code>
                                   <br><code>${findAngleLabel} ≈ ${formatNumber(
              targetAngleDeg,
              2
            )}°</code></p>
                                   <p><strong>4. Formato Grados/Minutos:</strong> <code>${findAngleLabel} ≈ ${correctAnswer}</code></p>`;
            break;
        }
        return {
          questionText,
          correctAnswer,
          type: "cosine",
          explanation,
          answerFormat: type === 2 ? "angle_deg_min" : "decimal",
        };
      }

      // --- Event Handlers ---
      topicSelector.addEventListener("click", (e) => {
        if (e.target.classList.contains("topic-button")) {
          topicButtons.forEach((btn) => btn.classList.remove("active"));
          e.target.classList.add("active");
          selectedTopic = e.target.dataset.topic;
          previousProblem = null;
          previousUserAnswer = "";
          previousProcedure = "";
          generateProblem();
        }
      });

      checkButton.addEventListener("click", () => {
        if (!currentProblem || checkButton.disabled) return;
        const userAnswerStr = answerInput.value.trim();
        if (userAnswerStr === "") {
          feedbackDiv.textContent = "Por favor, introduce una respuesta.";
          feedbackDiv.className = "incorrect";
          return;
        }
        let isCorrect = false;
        const correctAnswerStr = String(currentProblem.correctAnswer).trim();

        if (currentProblem.answerFormat === "angle_deg_min") {
          const parseDegMin = (str) => {
            const parts = str
              .replace(/°|d|m|'/gi, " ")
              .replace(/\s+/g, " ")
              .trim()
              .split(" ");
            const deg = parseFloat(parts[0]) || 0;
            const min = parseFloat(parts[1]) || 0;
            if (isNaN(deg) || isNaN(min)) return NaN;
            return deg + min / 60;
          };
          const userDeg = parseDegMin(userAnswerStr);
          const correctDeg = parseDegMin(correctAnswerStr);
          if (!isNaN(userDeg) && !isNaN(correctDeg)) {
            isCorrect =
              Math.abs(userDeg - correctDeg) < ANGLE_MINUTE_TOLERANCE_DEG;
          } else {
            console.warn(
              "Could not parse angle input:",
              userAnswerStr,
              "or correct answer:",
              correctAnswerStr
            );
          }
        } else if (
          currentProblem.answerFormat &&
          currentProblem.answerFormat.startsWith("angle_deg")
        ) {
          const userValue = parseFloat(userAnswerStr);
          const correctValue = parseFloat(correctAnswerStr);
          if (!isNaN(userValue) && !isNaN(correctValue)) {
            isCorrect = Math.abs(userValue - correctValue) < ANGLE_TOLERANCE;
          }
        } else if (currentProblem.answerFormat === "decimal_1dp") {
          const userValue = parseFloat(userAnswerStr);
          const correctValue = parseFloat(correctAnswerStr);
          if (!isNaN(userValue) && !isNaN(correctValue)) {
            isCorrect = Math.abs(userValue - correctValue) < 0.05 + TOLERANCE;
          }
        } else {
          const userValue = parseFloat(userAnswerStr);
          const correctValue = parseFloat(correctAnswerStr);
          if (!isNaN(userValue) && !isNaN(correctValue)) {
            isCorrect = Math.abs(userValue - correctValue) < TOLERANCE;
            if (
              !isCorrect &&
              currentProblem.answerFormat === "integer" &&
              Math.abs(Math.round(userValue) - correctValue) < TOLERANCE
            ) {
              isCorrect = true;
            } else if (
              !isCorrect &&
              Number.isInteger(correctValue) &&
              Math.abs(userValue - correctValue) < 0.001
            ) {
              isCorrect = true;
            }
          }
          if (
            !isCorrect &&
            typeof correctAnswerStr === "string" &&
            userAnswerStr.toLowerCase() === correctAnswerStr.toLowerCase()
          ) {
            isCorrect = true;
          }
        }

        if (isCorrect) {
          feedbackDiv.innerHTML = "<strong>¡Correcto!</strong> 🎉";
          feedbackDiv.className = "correct";
        } else {
          let displayCorrect = correctAnswerStr;
          if (
            currentProblem.answerFormat !== "angle_deg_min" &&
            !isNaN(parseFloat(correctAnswerStr))
          ) {
            let dp = 2;
            if (currentProblem.answerFormat === "decimal_1dp") dp = 1;
            else if (currentProblem.answerFormat === "integer") dp = 0;
            else if (
              currentProblem.answerFormat &&
              currentProblem.answerFormat.startsWith("angle_deg")
            )
              dp = 1;
            displayCorrect = formatNumber(parseFloat(correctAnswerStr), dp);
            if (
              currentProblem.answerFormat &&
              currentProblem.answerFormat.startsWith("angle_deg") &&
              currentProblem.answerFormat !== "angle_deg_min"
            ) {
              displayCorrect += "°";
            }
          } else if (currentProblem.answerFormat === "angle_deg_min") {
            displayCorrect = currentProblem.correctAnswer;
          }
          feedbackDiv.innerHTML = `<strong>Incorrecto.</strong> La respuesta correcta es ${displayCorrect}.<hr><p><strong>Explicación:</strong></p>${currentProblem.explanation}`;
          feedbackDiv.className = "incorrect";
          // NO renderMath call needed
        }
      });

      newProblemButton.addEventListener("click", () => {
        generateProblem();
      });

      prevProblemButton.addEventListener("click", () => {
        if (previousProblem) {
          const tempProblem = currentProblem ? { ...currentProblem } : null;
          const tempAnswer = answerInput.value;
          const tempProcedure = procedureArea.value;
          currentProblem = previousProblem;
          answerInput.value = previousUserAnswer;
          procedureArea.value = previousProcedure;
          if (
            tempProblem &&
            tempProblem.questionText &&
            tempProblem.questionText !== "Selecciona un tema para empezar."
          ) {
            previousProblem = tempProblem;
            previousUserAnswer = tempAnswer;
            previousProcedure = tempProcedure;
          } else {
            previousProblem = null;
            previousUserAnswer = "";
            previousProcedure = "";
          }
          problemDisplay.innerHTML = currentProblem.questionText;
          // NO renderMath call needed
          feedbackDiv.innerHTML = "";
          feedbackDiv.className = "";
          setButtonsState(true);
        }
      });

      // --- Initial Setup ---
      document.addEventListener("DOMContentLoaded", () => {
        setButtonsState(false);
        prevProblemButton.disabled = true;
        problemDisplay.textContent = "Selecciona un tema para empezar.";
      });
    </script>
  </body>
</html>
